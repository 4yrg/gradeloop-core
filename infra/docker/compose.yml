services:
  # ============================================================================
  # Databases
  # ============================================================================
  # Only needed for Prod or if you explicitly want a DB. Go services in Dev use SQLite.
  # We'll keep them here so they can be used for Postgres testing if needed.
  user-db:
    image: postgres:15-alpine
    restart: always
    env_file:
      - ../../.env
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    volumes:
      - user-db-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - gradeloop-net

  db-manager:
    image: adminer
    restart: always
    ports:
      - "8084:8080"
    networks:
      - gradeloop-net

  # ============================================================================
  # Shared Infrastructure
  # ============================================================================
  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "8088:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - gradeloop-net

  rabbitmq:
    image: rabbitmq:3-management-alpine
    restart: always
    ports:
      - "5673:5672"
      - "8087:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 30s
      retries: 5
    networks:
      - gradeloop-net

  minio:
    image: minio/minio:latest
    restart: always
    command: server /data --console-address ":9001"
    env_file:
      - ../../.env
    ports:
      - "8085:9000"
      - "8086:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - gradeloop-net

  kong:
    image: kong:3.4
    restart: always
    env_file:
      - ../../.env
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /usr/local/kong/declarative/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8091, 0.0.0.0:8090 ssl
    volumes:
      - ./kong.yml:/usr/local/kong/declarative/kong.yml
    ports:
      - "8080:8000"
      - "8089:8443"
      - "8091:8091"
      - "8090:8090"
    networks:
      - gradeloop-net

  # ============================================================================
  # Go Microservices (Dev: SQLite)
  # ============================================================================
  identity-service:
    build:
      context: ../../
      dockerfile: services/go/identity/Dockerfile
    env_file:
      - ../../.env
    environment:
      - ENVIRONMENT=development
      - DB_DRIVER=sqlite
      - SQLITE_PATH=/app/data/identity.db
    networks:
      - gradeloop-net
    volumes:
      - identity-data:/app/data
    develop:
      watch:
        - action: rebuild
          path: ../../services/go/identity
        - action: rebuild
          path: ../../libs

  session-service:
    build:
      context: ../../
      dockerfile: services/go/session/Dockerfile
    env_file:
      - ../../.env
    environment:
      - DB_DRIVER=sqlite
      - DB_DSN=/app/data/session.db
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - gradeloop-net
    volumes:
      - session-data:/app/data
    develop:
      watch:
        - action: rebuild
          path: ../../services/go/session
        - action: rebuild
          path: ../../libs

  email-service-go:
    build:
      context: ../../
      dockerfile: services/go/email/Dockerfile
    env_file:
      - ../../.env
    environment:
      - DB_DRIVER=sqlite
      - SQLITE_PATH=/app/data/email.db
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - gradeloop-net
    volumes:
      - email-go-data:/app/data
    develop:
      watch:
        - action: rebuild
          path: ../../services/go/email
        - action: rebuild
          path: ../../libs

  authn-service:
    build:
      context: ../../
      dockerfile: services/go/authn/Dockerfile
    env_file:
      - ../../.env
    ports:
      - "${AUTHN_PORT:-8083}:${AUTHN_PORT:-8083}"
    depends_on:
      - identity-service
      - session-service
      - email-service-go
    networks:
      - gradeloop-net
    develop:
      watch:
        - action: rebuild
          path: ../../services/go/authn
        - action: rebuild
          path: ../../libs
  # ============================================================================
  # Python Services
  # ============================================================================
  # keystroke-ml-service:
  #   build:
  #     context: ../../
  #     dockerfile: services/python/keystroke-service/Dockerfile
  #   env_file:
  #     - ../../.env
  #   environment:
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     RABBITMQ_HOST: rabbitmq
  #   ports:
  #     - "8082:8003"
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #     rabbitmq:
  #       condition: service_healthy
  #   networks:
  #     - gradeloop-net
  #   volumes:
  #     - keystroke-models:/app/models
  #   develop:
  #     watch:
  #       - action: sync+restart
  #         path: ../../services/python/keystroke-service
  #         target: /app

volumes:
  user-db-data:
  minio-data:
  redis-data:
  rabbitmq-data: # keystroke-models:

  identity-data:
  session-data:
  email-go-data:


networks:
  gradeloop-net:
    driver: bridge
