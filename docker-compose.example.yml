version: '3.8'

# This compose file is for local development.
# To run this, make sure your project's Python dependencies are installed on your host machine
# or ensure the Dockerfiles build correctly.

services:
  # --- Database Service ---
  ccd-postgres:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: ccd_db
    volumes:
      - ccd-postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432" # Expose to host for direct access if needed
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U user -d ccd_db" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- MinIO Object Storage Service (S3-compatible) ---
  ccd-minio:
    image: minio/minio
    restart: always
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - ccd-minio-data:/data
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # MinIO Console
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- FastAPI Inference Microservice ---
  model-orchestrator-dev:
    # Use build context to target the model-orchestrator app directory
    build:
      context: ./apps/model-orchestrator
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    # Mount the entire model-orchestrator app for live development changes
    volumes:
      - ./apps/model-orchestrator:/app/apps/model-orchestrator
      # Mount artifacts directory for scripts (e.g., embeddings, reports)
      - ./apps/model-orchestrator/app/models/cipas/code_clone_detection/artifacts:/app/apps/model-orchestrator/app/models/cipas/code_clone_detection/artifacts
      # Mount notebooks for local development
      - ./notebooks:/app/notebooks
      # Ensure CodeNet dataset is accessible if needed by scripts
      # - D:/Projects/SLIIT/Research/Datasets/Project_CodeNet:/data/Project_CodeNet
    environment:
      # Database connection for scripts/FastAPI app
      CODE_CLONE_DATABASE_URL: postgresql+asyncpg://user:password@ccd-postgres:5432/ccd_db
      # MinIO connection for scripts/FastAPI app
      CODE_CLONE_STORAGE_TYPE: s3
      CODE_CLONE_S3_ENDPOINT_URL: http://ccd-minio:9000
      CODE_CLONE_S3_ACCESS_KEY_ID: minioadmin
      CODE_CLONE_S3_SECRET_ACCESS_KEY: minioadmin
      # API Key for rebuild-index endpoint
      CIPLOC_API_KEY: super_secret_api_key
      # Other settings
      PYTHONPATH: /app # Ensure Python can find apps/model-orchestrator
    depends_on:
      ccd-postgres:
        condition: service_healthy
      ccd-minio:
        condition: service_healthy
    # Command to run uvicorn within the container.
    # Uvicorn will auto-reload when files in the mounted volume change.
    command: uvicorn 'main:app' --host=0.0.0.0 --port=8001 --reload

  # --- Optional: Redis for caching or task queues ---
  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  ccd-postgres-data:
  ccd-minio-data:
  redis-data:
