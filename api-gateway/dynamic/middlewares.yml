# ============================================================================
# Traefik Dynamic Configuration - Middlewares
# ============================================================================
# Defines reusable middleware chains for security, authentication, and policies
# ============================================================================

http:
  middlewares:
    # ========================================================================
    # Forward Authentication Middleware
    # ========================================================================
    # Delegates authentication to the auth-service
    # Auth service validates JWT and returns user context headers
    # ========================================================================
    forward-auth:
      forwardAuth:
        address: "http://auth-service:8080/internal/auth/validate"
        trustForwardHeader: true
        
        # Headers to forward to auth service
        authRequestHeaders:
          - "Authorization"
          - "Cookie"
          - "X-Forwarded-For"
          - "X-Forwarded-Host"
          - "X-Forwarded-Proto"
        
        # Headers returned by auth service and forwarded to backend
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Role"
          - "X-Institute-Id"
          - "X-User-Email"
          - "X-User-Name"
        
        # Response headers on auth failure
        authResponseHeadersRegex: "^X-"
    
    # ========================================================================
    # Role-Based Access Control Middlewares
    # ========================================================================
    # These middlewares check the X-User-Role header set by forward-auth
    # ========================================================================
    
    role-system-admin:
      headers:
        customRequestHeaders:
          X-Required-Role: "system-admin"
    
    role-institute-admin:
      headers:
        customRequestHeaders:
          X-Required-Role: "institute-admin,system-admin"
    
    role-instructor:
      headers:
        customRequestHeaders:
          X-Required-Role: "instructor,institute-admin,system-admin"
    
    role-student:
      headers:
        customRequestHeaders:
          X-Required-Role: "student,instructor,institute-admin,system-admin"
    
    # ========================================================================
    # CORS Middleware
    # ========================================================================
    cors-headers:
      headers:
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "PATCH"
          - "DELETE"
          - "OPTIONS"
        
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
          - "Accept"
          - "Origin"
          - "X-Requested-With"
          - "X-User-Id"
          - "X-User-Role"
          - "X-Institute-Id"
        
        accessControlAllowOriginList:
          - "https://gradeloop.local"
          - "https://app.gradeloop.local"
          - "https://admin.gradeloop.local"
          - "http://localhost:3000"
          - "http://localhost:3001"
        
        accessControlAllowCredentials: true
        accessControlMaxAge: 3600
        
        accessControlExposeHeaders:
          - "X-User-Id"
          - "X-User-Role"
          - "X-Institute-Id"
          - "X-Total-Count"
          - "X-Page-Number"
          - "X-Page-Size"
    
    # ========================================================================
    # Security Headers Middleware
    # ========================================================================
    security-headers:
      headers:
        # Security headers
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        forceSTSHeader: true
        
        # Content security
        contentTypeNosniff: true
        browserXssFilter: true
        frameDeny: true
        
        # Custom security headers
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "DENY"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Permissions-Policy: "geolocation=(), microphone=(), camera=()"
          Content-Security-Policy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
        
        # Remove server headers
        customRequestHeaders:
          X-Forwarded-Proto: "https"
    
    # ========================================================================
    # Rate Limiting Middlewares
    # ========================================================================
    # Different rate limits based on user role
    # ========================================================================
    
    # Auth endpoints - Strict limits to prevent brute force
    rate-limit-auth:
      rateLimit:
        average: 10
        period: 1m
        burst: 20
        sourceCriterion:
          ipStrategy:
            depth: 1
            excludedIPs:
              - "127.0.0.1/32"
    
    # Student endpoints - Lower limits
    rate-limit-student:
      rateLimit:
        average: 100
        period: 1m
        burst: 200
        sourceCriterion:
          requestHeaderName: X-User-Id
    
    # Instructor endpoints - Medium limits
    rate-limit-instructor:
      rateLimit:
        average: 200
        period: 1m
        burst: 400
        sourceCriterion:
          requestHeaderName: X-User-Id
    
    # Admin endpoints - Higher limits
    rate-limit-admin:
      rateLimit:
        average: 500
        period: 1m
        burst: 1000
        sourceCriterion:
          requestHeaderName: X-User-Id
    
    # ========================================================================
    # Request/Response Transformation Middlewares
    # ========================================================================
    
    # Strip path prefix (if needed)
    strip-api-prefix:
      stripPrefix:
        prefixes:
          - "/api"
        forceSlash: false
    
    # Add prefix (if needed)
    add-api-prefix:
      addPrefix:
        prefix: "/api"
    
    # ========================================================================
    # Compression Middleware
    # ========================================================================
    compress-response:
      compress:
        excludedContentTypes:
          - "text/event-stream"
          - "application/grpc"
        minResponseBodyBytes: 1024
    
    # ========================================================================
    # Retry Middleware
    # ========================================================================
    retry-policy:
      retry:
        attempts: 3
        initialInterval: 100ms
    
    # ========================================================================
    # Circuit Breaker Middleware
    # ========================================================================
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.30 || ResponseCodeRatio(500, 600, 0, 600) > 0.25"
        checkPeriod: 10s
        fallbackDuration: 30s
        recoveryDuration: 10s
    
    # ========================================================================
    # Request Size Limit Middleware
    # ========================================================================
    request-size-limit:
      buffering:
        maxRequestBodyBytes: 10485760  # 10MB
        memRequestBodyBytes: 2097152   # 2MB
        maxResponseBodyBytes: 10485760 # 10MB
        memResponseBodyBytes: 2097152  # 2MB
        retryExpression: "IsNetworkError() && Attempts() < 3"
    
    # ========================================================================
    # IP Whitelist Middleware (for internal endpoints)
    # ========================================================================
    internal-only:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"
        ipStrategy:
          depth: 1
    
    # ========================================================================
    # Custom Error Pages Middleware
    # ========================================================================
    error-pages:
      errors:
        status:
          - "400-599"
        service: error-page-service
        query: "/{status}.html"
    
    # ========================================================================
    # Request Logging Middleware
    # ========================================================================
    request-logger:
      accessLog:
        filePath: "/var/log/traefik/access.log"
        format: json
        bufferingSize: 100
