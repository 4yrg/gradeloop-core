# Comments are provided throughout this file to help you get started.
# If you need more help, visit the Docker Compose reference guide at
# https://docs.docker.com/go/compose-spec-reference/

# Here the instructions define your application as a service called "server".
# This service is built from the Dockerfile in the current directory.
# You can add other services your application may depend on here, such as a
# database or a cache. For examples, see the Awesome Compose repository:
# https://github.com/docker/awesome-compose
services:
  fastapi-template:
    build:
      context: ./apps/fastapi-template
    ports:
      - 8000:8000

  go-template:
    build:
      context: ./apps/go-template
    ports:
      - 3000:3000

  model-orchestrator:
    build:
      context: ./apps/model-orchestrator
    ports:
      - "8001:8001"
    # For production, consider using Docker secrets instead of environment variables.
    environment:
      - CODE_CLONE_DATABASE_URL=postgresql+asyncpg://user:password@ccd-postgres:5432/ccd_db
      - CODE_CLONE_STORAGE_TYPE=s3
      - CODE_CLONE_S3_ENDPOINT_URL=http://ccd-minio:9000
      - CODE_CLONE_S3_ACCESS_KEY_ID=minioadmin
      - CODE_CLONE_S3_SECRET_ACCESS_KEY=minioadmin
    depends_on:
      ccd-postgres:
        condition: service_healthy
      ccd-minio:
        condition: service_healthy

  ccd-postgres:
    image: postgres:15
    restart: always
    # For production, use secrets for credentials.
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=ccd_db
    volumes:
      - ccd-postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U user -d ccd_db" ]
      interval: 10s
      timeout: 5s
      retries: 5

  ccd-minio:
    image: minio/minio
    restart: always
    command: server /data --console-address ":9001"
    # For production, use secrets for credentials.
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - ccd-minio-data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  ccd-postgres-data:
  ccd-minio-data:
